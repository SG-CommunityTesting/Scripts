name: Validate JSON in target repo

on:
  workflow_dispatch:    # manual trigger
  pull_request:         # triggers on PRs targeting main
    branches: [main]
    paths:
      - '**/*.json'
  push:
    branches: [main]    # triggers on direct pushes
    paths:
      - '**/*.json'

jobs:
  validate-target-repo:
    runs-on: ubuntu-latest
    steps:
      # 1Ô∏è‚É£ Checkout the target repo
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          repository: SG-CommunityTesting/SG-NL-Balance
          token: ${{ secrets.GITHUB_TOKEN }}
          path: target-repo

      # 2Ô∏è‚É£ Checkout the CI scripts repo (self)
      - name: Checkout CI scripts
        uses: actions/checkout@v4
        with:
          path: ci-scripts

      # 3Ô∏è‚É£ Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      # 4Ô∏è‚É£ Run JSON validation
      - name: Run JSON validation
        id: validation
        working-directory: target-repo
        run: |
          python ../ci-scripts/run_balance_validation.py --path . > validation_output.log || exit 0
        continue-on-error: true

      # 5Ô∏è‚É£ Post results as a PR comment (if PR)
      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          header: "üí• JSON Validation Results"
          message: |
            ``` 
            $(cat target-repo/validation_output.log || echo "No output captured")
            ```
